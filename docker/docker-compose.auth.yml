version: '3.8'

# MCP Authorization Testing Stack
# Ory Hydra OAuth 2.1 Server + Consent App
#
# Usage:
#   docker-compose -f docker/docker-compose.auth.yml up
#
# Endpoints:
#   - Hydra Public API: http://localhost:4444 (auth, token endpoints)
#   - Hydra Admin API:  http://localhost:4445 (client management, introspection)
#   - Consent App:      http://localhost:3000 (login/consent UI)

services:
  hydra:
    image: oryd/hydra:v2.2
    container_name: mcp-hydra
    ports:
      - "4444:4444"  # Public API
      - "4445:4445"  # Admin API
    environment:
      - DSN=memory
      - URLS_SELF_ISSUER=http://localhost:4444
      - URLS_LOGIN=http://localhost:3000/login
      - URLS_CONSENT=http://localhost:3000/consent
      - URLS_LOGOUT=http://localhost:3000/logout
      - SECRETS_SYSTEM=mcp-demo-secret-at-least-32-chars
      - OAUTH2_EXPOSE_INTERNAL_ERRORS=true
      - LOG_LEVEL=debug
      - SERVE_PUBLIC_CORS_ENABLED=true
      - SERVE_PUBLIC_CORS_ALLOWED_ORIGINS=*
      - SERVE_ADMIN_CORS_ENABLED=true
      - SERVE_ADMIN_CORS_ALLOWED_ORIGINS=*
      # Enable PKCE for public clients
      - OAUTH2_PKCE_ENFORCED=true
      - OAUTH2_PKCE_ENFORCED_FOR_PUBLIC_CLIENTS=true
    command: serve all --dev
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:4444/health/ready"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - mcp-auth

  hydra-migrate:
    image: oryd/hydra:v2.2
    container_name: mcp-hydra-migrate
    environment:
      - DSN=memory
    command: migrate sql -e --yes
    networks:
      - mcp-auth
    depends_on:
      - hydra

  consent-app:
    build:
      context: ./consent-app
      dockerfile: Dockerfile
    container_name: mcp-consent-app
    ports:
      - "3000:3000"
    environment:
      - HYDRA_ADMIN_URL=http://hydra:4445
      - PORT=3000
      - NODE_ENV=development
    depends_on:
      hydra:
        condition: service_healthy
    networks:
      - mcp-auth

  # Client registration on startup using REST API (more reliable than CLI)
  hydra-clients:
    image: curlimages/curl:latest
    container_name: mcp-hydra-clients
    entrypoint: /bin/sh
    command:
      - -c
      - |
        sleep 5
        echo "Waiting for Hydra to be ready..."

        # Wait for Hydra admin API
        until curl -sf http://hydra:4445/health/ready > /dev/null 2>&1; do
          echo "Waiting for Hydra..."
          sleep 2
        done

        echo "Registering MCP OAuth clients via REST API..."

        # CLI Client (public client with PKCE)
        curl -X POST http://hydra:4445/admin/clients \
          -H "Content-Type: application/json" \
          -d '{
            "client_id": "cli-client",
            "client_name": "MCP CLI Client",
            "grant_types": ["authorization_code", "refresh_token"],
            "response_types": ["code"],
            "scope": "openid offline_access mcp:read mcp:write analytics:read analytics:write",
            "redirect_uris": ["http://localhost:8085/callback"],
            "token_endpoint_auth_method": "none",
            "skip_consent": true
          }' && echo ""

        # Analytics Server (confidential client for introspection)
        curl -X POST http://hydra:4445/admin/clients \
          -H "Content-Type: application/json" \
          -d '{
            "client_id": "analytics-server",
            "client_name": "Analytics Server",
            "client_secret": "analytics-server-secret",
            "grant_types": ["client_credentials"],
            "response_types": ["token"],
            "scope": "introspect",
            "token_endpoint_auth_method": "client_secret_basic"
          }' && echo ""

        # Dev Tools Server (confidential client for introspection)
        curl -X POST http://hydra:4445/admin/clients \
          -H "Content-Type: application/json" \
          -d '{
            "client_id": "dev-tools-server",
            "client_name": "Dev Tools Server",
            "client_secret": "dev-tools-server-secret",
            "grant_types": ["client_credentials"],
            "response_types": ["token"],
            "scope": "introspect",
            "token_endpoint_auth_method": "client_secret_basic"
          }' && echo ""

        echo "OAuth clients registered successfully!"
    depends_on:
      hydra:
        condition: service_healthy
    networks:
      - mcp-auth

networks:
  mcp-auth:
    driver: bridge
